#!/bin/bash
# uesama-send: ペイン名で send-keys を実行するラッパー
# usage: uesama-send <pane_name> <message>          # メッセージ送信 + 自動Enter
#        uesama-send <pane_name> <message> --no-enter # メッセージ送信のみ（Enter無し）
#        uesama-send <pane_name> Enter               # Enterキーのみ送信
#        uesama-send --resolve <pane_name>           # ペインID解決
#
# メッセージ送信時はデフォルトで sleep 0.3 後に Enter を送る。
# 引数が "Enter" 単体の場合は tmux send-keys にそのまま渡す。
#
# 例:
#   uesama-send sanbo 'メッセージ'              # メッセージ + Enter
#   uesama-send sanbo 'メッセージ' --no-enter   # メッセージのみ
#   uesama-send sanbo Enter                     # Enterキーのみ
#   tmux capture-pane -t $(uesama-send --resolve sanbo) -p
set -e

PROJ_UESAMA="${UESAMA_PROJECT_DIR:-.}/.uesama"
PANES_FILE="$PROJ_UESAMA/panes.yaml"

# --resolve モード: ペインIDだけ返す
RESOLVE_ONLY=false
if [ "$1" = "--resolve" ]; then
    RESOLVE_ONLY=true
    shift
fi

PANE_NAME="$1"
shift || true

if [ -z "$PANE_NAME" ]; then
    echo "usage: uesama-send [--resolve] <pane_name> [message_or_Enter]" >&2
    exit 1
fi

if [ ! -f "$PANES_FILE" ]; then
    echo "エラー: $PANES_FILE が見つかりません。uesama を起動してください。" >&2
    exit 1
fi

# panes.yaml からペインIDを取得
PANE_ID=$(grep "^${PANE_NAME}:" "$PANES_FILE" 2>/dev/null | awk '{print $2}')

if [ -z "$PANE_ID" ]; then
    echo "エラー: ペイン '${PANE_NAME}' が panes.yaml に見つかりません。" >&2
    echo "利用可能なペイン:" >&2
    grep -v '^#' "$PANES_FILE" | awk -F: '{print "  " $1}' >&2
    exit 1
fi

if [ "$RESOLVE_ONLY" = true ]; then
    echo "$PANE_ID"
    exit 0
fi

# --enter オプション検出
SEND_ENTER=false
ARGS=()
for arg in "$@"; do
    if [ "$arg" = "--enter" ]; then
        SEND_ENTER=true
    else
        ARGS+=("$arg")
    fi
done

# send-keys 実行
if [ ${#ARGS[@]} -eq 0 ] && [ "$SEND_ENTER" = false ]; then
    echo "エラー: メッセージまたは Enter を指定してください。" >&2
    exit 1
fi

if [ ${#ARGS[@]} -gt 0 ]; then
    tmux send-keys -t "$PANE_ID" "${ARGS[@]}"
fi

if [ "$SEND_ENTER" = true ]; then
    sleep 0.3
    tmux send-keys -t "$PANE_ID" Enter
fi
