#!/bin/sh
# uesama ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒ¼
set -e

REPO_URL="https://github.com/y-nishizaki/uesama"
UESAMA_HOME="$HOME/.uesama"

if [ ! -d "$UESAMA_HOME" ]; then
    echo "  uesama ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚install.sh ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
    exit 1
fi

echo ""
echo "  ðŸ¯ uesama ã‚’æ›´æ–°ä¸­..."
echo ""

# ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚½ãƒ¼ã‚¹å–å¾—
TMPDIR=$(mktemp -d)
cleanup() {
    rm -rf "$TMPDIR"
}
trap cleanup EXIT

if command -v git >/dev/null 2>&1; then
    git clone --depth 1 "$REPO_URL.git" "$TMPDIR/uesama" >/dev/null 2>&1
    SRC="$TMPDIR/uesama"
else
    curl -fsSL "$REPO_URL/archive/refs/heads/main.tar.gz" -o "$TMPDIR/uesama.tar.gz"
    tar xzf "$TMPDIR/uesama.tar.gz" -C "$TMPDIR"
    SRC="$TMPDIR/multi-agent-shogun-main"
fi

# bin/, scripts/, template/ ã‚’ä¸Šæ›¸ãæ›´æ–°
cp -r "$SRC/bin/"* "$UESAMA_HOME/bin/"
cp -r "$SRC/scripts/"* "$UESAMA_HOME/scripts/"

rm -rf "$UESAMA_HOME/template/.uesama" "$UESAMA_HOME/template/.claude"
mkdir -p "$UESAMA_HOME/template/.uesama"
cp -r "$SRC/template/instructions" "$UESAMA_HOME/template/.uesama/"
cp -r "$SRC/template/templates" "$UESAMA_HOME/template/.uesama/"

# settings.yaml ãƒžãƒ¼ã‚¸ï¼ˆæ–°ã‚­ãƒ¼ã®ã¿è¿½åŠ ã€æ—¢å­˜ã‚­ãƒ¼ã¯ä¿æŒï¼‰
NEW_SETTINGS="$SRC/template/config/settings.yaml"
USER_SETTINGS="$UESAMA_HOME/config/settings.yaml"
if [ -f "$NEW_SETTINGS" ] && [ -f "$USER_SETTINGS" ]; then
    # æ–°ã—ã„è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å„è¡Œã«ã¤ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã«å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã®ã¿è¿½åŠ 
    while IFS= read -r line; do
        key=$(echo "$line" | sed -n 's/^\([a-zA-Z_][a-zA-Z0-9_]*\):.*/\1/p')
        [ -z "$key" ] && continue
        if ! grep -q "^${key}:" "$USER_SETTINGS" 2>/dev/null; then
            echo "$line" >> "$USER_SETTINGS"
        fi
    done < "$NEW_SETTINGS"
elif [ -f "$NEW_SETTINGS" ] && [ ! -f "$USER_SETTINGS" ]; then
    mkdir -p "$UESAMA_HOME/config"
    cp "$NEW_SETTINGS" "$USER_SETTINGS"
fi

# å®Ÿè¡Œæ¨©é™ä»˜ä¸Ž
chmod +x "$UESAMA_HOME/bin/"*
chmod +x "$UESAMA_HOME/scripts/"*

echo "  âœ… æ›´æ–°å®Œäº†ï¼"
echo ""
